# Story 1.3: Deploy Firebase Functions to Production

**Epic:** Phase 1 - Foundation
**Status:** Draft

## Story

**As a** developer,
**I want** Firebase Functions deployed to production,
**so that** backend services (bookings, email, AI chat) run securely server-side.

## Acceptance Criteria

1. ✅ Firebase Functions code compiles without errors
2. ✅ Functions deployed to Firebase project
3. ✅ Environment variables configured in Functions
4. ✅ CORS properly configured for frontend domain
5. ✅ Functions are callable from frontend
6. ✅ Error logging and monitoring set up

## Tasks / Subtasks

- [ ] Review and Update Functions Code (AC: 1)
  - [ ] Navigate to `functions/` directory
  - [ ] Run `npm install` to install dependencies
  - [ ] Review `functions/src/index.ts` - verify all endpoints exported
  - [ ] Fix any TypeScript compilation errors: `npm run build`
  - [ ] Verify no placeholder API keys in code

- [ ] Configure Environment Secrets (AC: 3)
  - [ ] Set up Firebase Functions secrets:
    ```bash
    firebase functions:secrets:set GEMINI_API_KEY
    firebase functions:secrets:set RESEND_API_KEY
    firebase functions:secrets:set GOOGLE_CALENDAR_CREDENTIALS
    ```
  - [ ] Update functions code to use `defineSecret()` from firebase-functions/params
  - [ ] Document required secrets in `functions/README.md`

- [ ] Configure CORS (AC: 4)
  - [ ] Update CORS config in functions to allow production domain
  - [ ] Add localhost for development testing
  - [ ] Test OPTIONS preflight requests

- [ ] Deploy Functions (AC: 2, 5)
  - [ ] Login to Firebase: `firebase login`
  - [ ] Set project: `firebase use recanto-da-natureza-prod`
  - [ ] Deploy: `firebase deploy --only functions`
  - [ ] Note function URLs from deployment output
  - [ ] Test each function endpoint with curl/Postman

- [ ] Set Up Monitoring (AC: 6)
  - [ ] Enable Error Reporting in Firebase Console
  - [ ] Set up email alerts for function failures
  - [ ] Configure Cloud Logging filters for critical errors
  - [ ] Add structured logging to functions code

- [ ] Update Frontend to Use Production Functions (AC: 5)
  - [ ] Update `.env.local` with production function URLs
  - [ ] Or use Firebase SDK `httpsCallable()` (auto-discovers URLs)
  - [ ] Test frontend → functions communication
  - [ ] Verify API keys are NOT exposed in browser

## Dev Notes

### Current State
[Source: Assessment by Sarah]
- Functions code exists in `functions/src/`:
  - `booking-management.ts` - Create/manage bookings
  - `services/calendar.service.ts` - Google Calendar integration
  - `services/email.service.ts` - Resend email service
  - `services/gemini.service.ts` - Gemini AI chat
- Code is NOT deployed yet (local only)
- Functions use placeholder environment variables

### Functions Architecture
[Source: architecture/6-api-design.md]

**Endpoints to Deploy:**
1. `createBooking` - POST booking data, create calendar event, send emails
2. `getAvailability` - GET available dates for a unit from Google Calendar
3. `chatWithAI` - POST message, return Gemini response
4. `adminGetBookings` - GET all bookings (admin only)
5. `adminUpdateUnit` - PUT unit data (admin only)

### Required Environment Secrets
[Source: architecture/7-external-api-integration.md]
- `GEMINI_API_KEY` - Google AI Studio API key
- `RESEND_API_KEY` - Resend email service key
- `GOOGLE_CALENDAR_CREDENTIALS` - Service account JSON (base64 encoded)
- `OWNER_EMAIL` - Email for booking notifications

### Firebase Functions Configuration
[Source: architecture/3-tech-stack.md]
```javascript
// functions/src/index.ts
import { defineSecret } from 'firebase-functions/params';

const geminiKey = defineSecret('GEMINI_API_KEY');
const resendKey = defineSecret('RESEND_API_KEY');

export const chatWithAI = onRequest(
  { secrets: [geminiKey], cors: true },
  async (req, res) => {
    // Function implementation
  }
);
```

### CORS Configuration
```typescript
const corsOptions = {
  origin: [
    'http://localhost:3000',
    'https://recanto-da-natureza.vercel.app', // Update with actual domain
  ],
  credentials: true,
};
```

### Deployment Commands
```bash
# Install Firebase CLI if needed
npm install -g firebase-tools

# Login and select project
firebase login
firebase use recanto-da-natureza-prod

# Deploy only functions (not hosting/rules)
firebase deploy --only functions

# Deploy specific function
firebase deploy --only functions:createBooking
```

### Testing
[Source: architecture/11-testing-strategy.md]
- Unit tests for functions: `functions/test/` (use Firebase emulator)
- Integration test: curl each endpoint after deployment
- Security test: verify unauthenticated requests are blocked where appropriate

### Important Notes
- Functions require Blaze (pay-as-you-go) plan
- Cold start time: ~1-2 seconds (first request after idle)
- Keep functions small and focused (faster cold starts)
- Use Firebase Admin SDK for Firestore access (auto-authenticated)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-10 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev agent_

### Debug Log References
_To be filled by Dev agent_

### Completion Notes
_To be filled by Dev agent_

### File List
_To be filled by Dev agent_

## QA Results
_To be filled by QA agent_
